<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Don Coleman - Bluetooth Low Energy - Android Alliance Philadelphia</title>

        <meta name="description" content="Bluetooth Low Energy and Android">
        <meta name="author" content="Don Coleman">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <!-- <link rel="stylesheet" href="css/theme/black.css" id="theme"> -->
        <link rel="stylesheet" href="css/theme/sky.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <!-- hack the style a bit -->
        <style>

         .reveal pre {
            font-size: 0.65em;
            width: 100%;
          }

          .reveal h1,
          .reveal h2,
          .reveal h3,
          .reveal h4,
          .reveal h5,
          .reveal h6 {
            text-transform: none;
          }

          .reveal section img {
              border: none;
          }

          .reveal ul {
            list-style-type: none
          }

      </style>
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
          <div class="slides">

            <section>
              <h2>Bluetooth Low Energy</h2>
              <h3>for Android</h3>
              <p>Android Alliance Philadelphia - November 11, 2015</p>
              <p>Don Coleman - Chariot Solutions</p>
              <p><a href="http://twitter.com/doncoleman">@doncoleman</a></p>
            </section>

            <section>
              <img src="images/bluetooth.png">
            </section>

            <section>
              <!-- based on - Figure 3.1 from “Bluetooth Low Energy” by Robin Heydon -->
              <img width="60%" src="images/architecture.svg">
            </section>

            <section>
              <h2>Lightbulb Service</h2>
                <ul>
                  <li>Light Switch</li>
                  <li>Dimmer Setting</li>
                </ul>
            </section>

            <section>
              <h2>Lightbulb Service - FF10</h2>
              <img src="images/uuid.png" />
            </section>

            <section>
              <h2>16 bit UUIDs</h2>
              <p style="color:#888">0000<span style="color:#000"><b>FF10</b></span>-0000-1000-8000-00805F9B34FB</p>
              <p style="color:#888">0000<span style="color:#000"><b>FF11</b></span>-0000-1000-8000-00805F9B34FB</p>
              <p style="color:#888">0000<span style="color:#000"><b>FF12</b></span>-0000-1000-8000-00805F9B34FB</p>
            </section>

            <section>
              <h2>Lightbulb Service - FF10</h2>
              <img src="images/lightbulb-service.png" />
            </section>

            <section>
              <h2>Properties</h2>
              <!--
              <ul>
                <li>Read</li>
                <li>Write</li>
                <li>Write Command</li>
                <li>Notification</li>
                <li>Indication</li>
              </ul>

              Encryption required for notification and indication
              -->
              <h2>Attributes</h2>
              <!--
                Value
                Handle
              -->
              <h2>Permissions</h2>
              <!--
                Encryption / No Encryption
              -->
              <h2>Descriptors</h2>
              <!--
                Human readable description
                Valid range
                Format - UTF-8, int, float
              -->
            </section>

            <!--
            <section>
                <h2>GAP</h2>
                <h2>Generic Access Profile</h2>
            </section>
            -->

            <section>
              <h2>Advertising</h2>
              <img width="50%" src="images/advertise.svg" />
            </section>

            <section>
              <h2>Advertising</h2>
              <ul>
                <li>78:C5:E5:9A:88:EE</li>
                <li>Services: [ 0x180A, 0xFF10, 0XFF20, …] </li>
                <li>Manufacturer Data: <00007465 6d70></li>
                <li>Connectable: True</li>
                <li>TX Power Level: 4</li>
                <li>RSSI: -80</li>
                <li>Name: Smart Lightbulb</li>
              </ul>
            </section>

            <section>
              <img width="100%" src="images/ble_advertisement.png" />
            </section>

            <section>
              <img width="100%" src="images/ble_connection.png" />
            </section>

<!--
            <section>
              <h2>Connect</h2>
              <img width="80%" src="images/connect.svg" />
            </section>
-->
            <section>
              <h2>After Connecting...</h2>
              <!-- discover -->
              <ul>
              <li class="fragment">Get a list of services</li>
              <li class="fragment">For each service, get a list of characteristics</li>
              <li class="fragment">For each characteristic, get properties</li>
              <li class="fragment">Save handle to read or write later</li>
              <li class="fragment">Subscribe to be notified on changes</li>
              <ul>
            </section>

            <!-- attribute protocol -->

           <section>
              <h2>Read Value</h2>
              <img width="80%" src="images/read.svg">
            </section>

            <section>
              <h2>Write Value</h2>
              <img width="80%" src="images/write.svg">
            </section>

            <section>
              <h2>Write Command</h2>
              <img width="80%" src="images/command.svg">
            </section>

<!--
            <section>
              <h2>Battery Service</h2>
              <p>0x180F</p>
              <img src="images/battery_service.png" />
            </section>
            -->

            <section>
              <h2>Heart Rate Service - 180d</h2>
              <img src="images/heart_rate_service.png" />
              <small>
              <a href="https://developer.bluetooth.org/gatt/services/Pages/ServiceViewer.aspx?u=org.bluetooth.service.heart_rate.xml">org.bluetooth.service.heart_rate.xml</a><br/>
              <a href="https://developer.bluetooth.org/gatt/characteristics/Pages/CharacteristicViewer.aspx?u=org.bluetooth.characteristic.heart_rate_measurement.xml">org.bluetooth.characteristic.heart_rate_measurement.xml</a>
              </small>
            </section>

            <section>
              <h2>Notification</h2>
              <img width="80%" src="images/notification.svg">
            </section>

            <section>
              <h2>Indication</h2>
              <img width="80%" src="images/indication.svg">
            </section>

            <section>
              <img width="100%" src="images/data_transfer.png" />
            </section>

            <!-- <section>
              <h2>Security</h2>
              <a class="fragment" href="https://github.com/mikeryan/crackle">https://github.com/mikeryan/crackle</a>
            </section> -->

            <!--
            <section>
              <h2>Permissions</h2>
            </section>
            -->

            <!--
            <section>
              <h2>Bonding</h2>
            </section>
            -->

<!-- summary
            <section>
              <h2>Peripheral</h2>
              <p>Provides services</p>
            </section>

            <section>
              <h2>Central</h2>
              <ul>
                <li>Discover advertising peripherals</li>
                <li>Connect using MAC Address or UUID</li>
                <li>Explore the services and characteristics</li>
                <li>Read and write characteristics</li>
                <li>Subscribe to be notified of changes</li>
              </ul>
            </section>
-->
            <section>
              <h2>Lightbulb Service - FF10</h2>
              <img src="images/lightbulb-service.png" />
            </section>

            <section>
                <img width="80%" src="images/robosmart.jpg" />
            </section>

            <section>
                <img width="40%" src="images/nrf-scan.png" />
            </section>
            <section>
                <img width="40%" src="images/nrf-connected.png" />
            </section>
            <section>
                <img width="40%" src="images/nrf-ff10.png" />
            </section>

<!--
            <section>
                <img width="40%" src="images/lightblue-peripherals.png" />
            </section>
            <section>
                <img width="40%" src="images/lightblue-service.png" />
            </section>
            <section>
                <img width="40%" src="images/lightblue-characteristic.png" />
            </section>
-->
            <section>
                <h2>Android Bluetooth</h2>
            </section>

            <section>
                <h2>Permissions</h2>
                <ul>
                    <li>android.permission.BLUETOOTH</li>
                    <li>android.permission.BLUETOOTH_ADMIN</li>
                </ul>
            </section>

            <section>
                <h2>Permissions (android-23)</h2>
                <ul>
                    <li>android.permission.BLUETOOTH</li>
                    <li>android.permission.BLUETOOTH_ADMIN</li>
                    <li>android.permission.ACCESS_COARSE_LOCATION</li>
                    <li>android.permission.ACCESS_FINE_LOCATION</li>
                </ul>
            </section>

            <section>
                Marshmallow needs to ask for permissions at runtime
                <small>
                    <a href="http://developer.android.com/training/permissions/requesting.html">http://developer.android.com/training/permissions/requesting.html</a>
                </small>
            </section>

<section>
    <h3>Bluetooth Adapter</h3>
    <pre><code>
  BluetoothManager manager =
       activity.getSystemService(Context.BLUETOOTH_SERVICE);
  BluetoothAdapter adapter = manager.getAdapter();
    </code></pre>
</section>

<section>
    <h3>Scanning</h3>
    <pre><code>
  bluetoothAdapter.startLeScan(callback);
    </code></pre>
</section>

<section>
    <h3>Scanning (better)</h3>
    <pre><code>
  bluetoothAdapter.startLeScan(serviceUuids, callback);
    </code></pre>
</section>

<section>
    <h3>BluetoothAdapter.LeScanCallback</h3>
    <pre><code>
  public void onLeScan(BluetoothDevice device,
                       int rssi,
                       byte[] scanRecord) {
    // do something
  }
    </code></pre>
</section>

<section>
    Scanning 5.0, 21+
</section>

<section>
    <h3>ScanCallback</h3>
<pre><code>
  ScanCallback scanCallback = new ScanCallback() {
    public void onScanResult(int callbackType, ScanResult result) {
    }

    public void onScanFailed(int errorCode) {
    }
  };

</code></pre>
</section>

<section>
    <h3>Scanning</h3>
    <pre><code>
  BluetoothLeScanner scanner = adapter.getBluetoothLeScanner();
  List&lt;ScanFilter&gt; scanFilters = new ArrayList&lt;&gt;();
  scanFilters.add(
    new ScanFilter.Builder().setServiceUuid(
      new ParcelUuid(BLEThermometer.SERVICE_UUID)).build()
  );
  ScanSettings scanSettings = new ScanSettings.Builder().build();
  scanner.startScan(scanFilters, scanSettings, scanCallback);
    </code></pre>
</section>

<section>
    <h3>BluetoothGatt</h3>
    <h3>BluetoothGattCallback</h3>
</section>

<!--
connect
    device.connectGatt(...)

callback.onConnectionStateChange received STATE_CONNECTED
    gatt.discoverServices()

wait for callback.onServicesDiscovered to be called
    get the characteristics and save to a member variable
    read values
    register for notifications
-->

<section>
    <h3>Connection to Device</h3>
    <pre><code>
  device.connectGatt(context, autoConnect, bluetoothGattCallback);
    </code></pre>
</section>

<section>
    <h3>Connection State Change</h3>
    <pre><code>
  public void onConnectionStateChange(BluetoothGatt gatt,
                            int status, int state) {

    if (state == BluetoothGatt.STATE_CONNECTED) {
      this.gatt = gatt;
      gatt.discoverServices();
    }
  }
    </code></pre>
</section>

<section>
    <!-- don't access services or characteristics until this happens -->
    <h3>Services Discovered</h3>
    <pre><code>
public void onServicesDiscovered(BluetoothGatt gatt, int status) {
  BluetoothGattService service = gatt.getService(SERVICE_UUID);
  switchCharacteristic = service.getCharacteristic(SWITCH_UUID);
  brightnessCharacteristic = service.getCharacteristic(DIMMER_UUID);
}
    </code></pre>
</section>

<section>
    <h3>Read Characteristic</h3>
    <pre><code>
    gatt.readCharacteristic(switchCharacteristic);
    </code></pre>
</section>

<section>
    <h3>Read Characteristic Callback</h3>
    <pre><code>
  public void onCharacteristicRead(gatt, characteristic, status) {
    UUID uuid = characteristic.getUuid();

    if (uuid.equals(SWITCH_UUID)) {
      int switchState =
        characteristic.getIntValue(FORMAT_UINT8, 0);

       // update UI
      }
  }
    </code></pre>
</section>

<section>
    <h3>Write Characteristic</h3>
    <pre><code>
  byte data[] = { 0x01 };
  characteristic.setValue(data);
  gatt.writeCharacteristic(characteristic);
    </code></pre>
</section>

<section>
    <h3>Write Characteristic</h3>
    <pre><code>
  switchCharacteristic.setValue(1, FORMAT_UINT8, 0);
  gatt.writeCharacteristic(switchCharacteristic);
    </code></pre>
</section>

<section>
    <h3>Write Characteristic Callback</h3>
    <pre><code>
  public void onCharacteristicWrite(BluetoothGatt gatt,
      BluetoothGattCharacteristic characteristic, int status) {
    Log.d(TAG, "Wrote " + characteristic);
  }

</code></pre>
</section>

<section>
    <h2>Demo</h2>
</section>

<section>
  <h2>Thermometer Service - bbb0</h2>
  <img src="images/thermometer_service.png" />
</section>

<section>
    <h3>Register for Notification</h3>
    <pre><code>
if (gatt.setCharacteristicNotification(characteristic, true)) {
  // 0x2902 client characteristic configuration
  UUID uuid = UUID.fromString("00002902-0000-1000-8000-00805F9B34FB");

  BluetoothGattDescriptor descriptor =
                characteristic.getDescriptor(uuid);
  descriptor.setValue(BluetoothGattDescriptor.ENABLE_NOTIFICATION);
  gatt.writeDescriptor(descriptor);
}
    </code></pre>
</section>

<section>
    <h3>On Characteristic Changed</h3>
    <pre><code>
  public void onCharacteristicChanged(BluetoothGatt gatt,
               BluetoothGattCharacteristic characteristic) {

    if (characteristic.getUuid().equals(TEMPERATURE_UUID)) {
      float temperature = getFloat(characteristic, 0);
      Log.d(TAG, String.valueOf(temperature));

      float fahrenheit = 1.8f * temperature + 32;
      Log.d(TAG, String.valueOf(fahrenheit));

      // update the UI
    }
  }

</code></pre>
</section>

<section>
    <h2>Demo</h2>
</section>

<section>
    The API is async but MUST BE CALLED SERIALLY
</section>

            <section>
                <img width="80%" src="images/beacons.jpg" />
            </section>

            <section>
                <img width="80%" src="images/estimote.jpg" />
            </section>

            <!-- broadcast only -->
            <section>
                <h2>iBeacon</h2>
                <ul>
                    <li>UUID: 12345678-aaaa-bbbb-cccc-123456789abc</li>
                    <li>Major: 0x01</li>
                    <li>Minor: 0x01</li>
                </ul>
            </section>

            <section>
              <img width="40%" src="images/ibeacon-scan.png"/>
            </section>

            <section>
                <h2>Eddystone Beacon</h2>
                <ul>
                    <li>http://example.com</li>
                </ul>
            </section>

            <section>
              <img src="images/nrf-eddystone.png" width="40%"/>
            </section>

            <section>
              <img src="images/physical-web.png" width="40%"/>
            </section>

            <section>
                Create test beacons with Node.js
                <small><a href="https://github.com/don/node-eddystone-beacon">https://github.com/don/node-eddystone-beacon</a></small>
            </section>

            <!--
            <section>
                <h2>Code</h2>
                <a href="https://github.com/don/ibeacon-demo">https://github.com/don/ibeacon-demo</a>
            </section>
            -->

            <section>
                <h2>Creating Peripherals</h2>
                <p>Requires Lollipop (21) &amp; compatible hardware</p>
            </section>

            <section>
                bluetoothAdapter.isMultipleAdvertisementSupported()
            </section>

            <section>
                <h3>Create Service &amp; Characteristics</h3>
<!-- TODO move to gist -->
<pre><code>BluetoothGattService service =
    new BluetoothGattService(SERVICE_UUID, SERVICE_TYPE_PRIMARY);

BluetoothGattCharacteristic switchCharacteristic =
  new BluetoothGattCharacteristic(
    SWITCH_UUID,
    PROPERTY_READ | PROPERTY_WRITE,
    PERMISSION_READ | PERMISSION_WRITE);

BluetoothGattCharacteristic dimmerCharacteristic =
  new BluetoothGattCharacteristic(
    DIMMER_UUID,
    PROPERTY_READ | PROPERTY_WRITE,
    PERMISSION_READ | PERMISSION_WRITE);

service.addCharacteristic(switchCharacteristic);
service.addCharacteristic(dimmerCharacteristic);
</code></pre>
            </section>

            <section>
                <h3>BluetoothGattServerCallback</h3>
<pre><code>
BluetoothGattServerCallback callback = new BluetoothGattServerCallback(){
     @Override
     public void onCharacteristicReadRequest(BluetoothDevice device, int requestId, int offset, BluetoothGattCharacteristic characteristic) {
     }

     @Override
     public void onCharacteristicWriteRequest(BluetoothDevice device, int requestId, BluetoothGattCharacteristic characteristic, boolean preparedWrite, boolean responseNeeded, int offset, byte[] value) {
     }
 };
</code></pre>
            </section>

            <section>
                <h3>onCharacteristicReadRequest</h3>
<pre><code>
  if (SWITCH_UUID.equals(characteristic.getUuid())) {
      gattServer.sendResponse(device,
              requestId,
              BluetoothGatt.GATT_SUCCESS,
              0,
              getSwitchValue());
  }

</code></pre>
            </section>

            <section>
                <h3>onCharacteristicWriteRequest</h3>
<pre><code>
  if (SWITCH_UUID.equals(characteristic.getUuid())) {
      setSwitchValue(value);
  } else if (DIMMER_UUID.equals(characteristic.getUuid())) {
      setDimmerValue(value);
  }

  if (responseNeeded) {
      gattServer.sendResponse(device,
            requestId,
            BluetoothGatt.GATT_SUCCESS,
            0,
            value);
  }

</code></pre>
            </section>

            <section>
                <h3>Add Service</h3>
<pre><code>
  gattServer = bluetoothManager.openGattServer(
                    context, bluetoothGattServerCallback);
  gattServer.addService(service);

</code></pre>
            </section>

<section>
    <h3>Advertise Settings</h3>
    <pre><code>
private AdvertiseSettings getAdvertiseSettings() {
  AdvertiseSettings.Builder builder = new AdvertiseSettings.Builder();
  builder.setAdvertiseMode(AdvertiseSettings.ADVERTISE_MODE_BALANCED);
  builder.setTxPowerLevel(AdvertiseSettings.ADVERTISE_TX_POWER_HIGH);

  return builder.build();
}
    </code></pre>
</section>
<section>
    <h3>Advertise Data</h3>
    <pre><code>
  private AdvertiseData getAdvertisementData() {
    AdvertiseData.Builder builder = new AdvertiseData.Builder();
    builder.setIncludeDeviceName(true);
    builder.addServiceUuid(new ParcelUuid(SERVICE_UUID));

    return builder.build();
  }
    </code></pre>
</section>

        <section>
            <h3>Advertise Service</h3>
<pre><code>
  BluetoothLeAdvertiser bluetoothLeAdvertiser =
        bluetoothAdapter.getBluetoothLeAdvertiser();
  AdvertiseData advertisementData = getAdvertisementData();
  AdvertiseSettings advertiseSettings = getAdvertiseSettings();

  bluetoothLeAdvertiser.startAdvertising(advertiseSettings,
                                       advertisementData,
                                       advertiseCallback);

</code></pre>
        </section>

            <section>
            <h3>Check &amp; enable Bluetooth</h3>
<pre><code>
  if (!bluetoothAdapter.isEnabled()) {
    Intent intent =
         new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
    this.startActivityForResult(intent, ENABLE_BLUETOOTH_REQUEST);
    // process the result in onActivityResult
  }

</code></pre>
</section>

            <section>
              <h2>Demo</h2>
            </section>

            <section>
 <img width="50%" src="images/cover.png"><br/>
 <small><a href="http://www.amazon.com/gp/product/1457187094?ie=UTF8&camp=1789&creativeASIN=1457187094&linkCode=xm2&tag=dongit-20">pre-order on Amazon</a></small>
</section>


            <!-- <section>
              <h2>Handing Subscriptions</h2>
            </section> -->

            <section>
                <h2>Thank You</h2>
                <p>Don Coleman</p>
                <p><a href="http://twitter.com/doncoleman">@doncoleman</a></p>
                <p>
                    <a href="mailto:&#100;&#111;&#110;&#0064;&#99;&#104;&#97;&#114;&#105;&#111;&#116;&#115;&#111;&#108;&#117;&#116;&#105;&#111;&#110;&#115;.&#99;&#111;&#109;">&#100;&#111;&#110;&#0064;&#99;&#104;&#97;&#114;&#105;&#111;&#116;&#115;&#111;&#108;&#117;&#116;&#105;&#111;&#110;&#115;.&#99;&#111;&#109;</a>
                </p>
                <p>
                Slides <a href="http://don.github.io/slides/">
                    http://don.github.io/slides/</a>
                </p>

                <!-- should be using css -->
                <p>&nbsp;</p>
                <p>
                    <small>
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Bluetooth Low Energy for Android</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://don.github.io/slides/2015-11-11-phillyandroid" property="cc:attributionName" rel="cc:attributionURL">Don Coleman</a> <br/>is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Based on a work at <a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/don/slides/tree/gh-pages/2015-11-11-phillyandroid" rel="dct:source">https://github.com/don/.../2015-11-11-phillyandroid</a>.
                    </small>
                </p>
            </section>

            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

    </body>
</html>
